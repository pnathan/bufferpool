# Hacked version of cicd template, without the venv. Glued python and go together.


stages:
  - test
  - build

# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Pip's cache doesn't store the python packages
# https://pip.pypa.io/en/stable/topics/caching/
#
# If you want to also cache the installed packages, you have to install
# them in a virtualenv and cache it as well.
cache:
  paths:
    - .cache/pip
    - venv/

pytest:
  stage: test
  image: python:latest
  script:
    - python --version
    - python test_bufferpool.py


gotest:
  stage: test
  image: golang:latest
  script:
#    - go vet $(go list ./... | grep -v /vendor/)
#    - go test -v -race $(go list ./... | grep -v /vendor/)
    - go install gotest.tools/gotestsum@latest
    - cd go
    - gotestsum --junitfile report.xml --format standard-verbose
  artifacts:
    when: always
    reports:
      junit: go/report.xml

compile:
  stage: build
  image: golang:latest
  script:
    - cd go
    - mkdir -p bin
    - go build -o bin ./...
  artifacts:
    paths:
      - go/bin
